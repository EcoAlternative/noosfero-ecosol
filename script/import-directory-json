#!/usr/bin/env ruby

require_relative '../config/environment'

require 'action_controller'
#require 'action_controller/test_process.rb'

class UploadedData
  attr_accessor :path, :content_type, :size
  def original_filename
    File.basename self.path
  end
end

def create_category attributes
  return unless attributes.present?

  category = attributes['record']
  unless category
    parent = create_category $categories[attributes['parent_id']]
    name = if Category.where(name: attributes['title']).first then attributes['description'] else attributes['title'] end
    begin
      category = Category.new environment: $environment, name: name, parent: parent
      category[:id] = attributes['id'].to_i
      category.save!
    rescue => e
      puts "Error \"#{e.message}\" on #{attributes.inspect}"
      exit 1
    end
    attributes['record'] = category
  end
  category
end

$categories = {}

def create_enterprise attributes
  enterprise = Enterprise.new name: attributes['title'],
    identifier: attributes['title'].to_slug,
    lat: attributes['lat'], lng: attributes['lng'],
    description: attributes['description'],
    address: attributes['address'],
    contact_phone: attributes['phone']
    
  enterprise[:id] =  attributes['id'].to_i

  #p attributes['email']
  enterprise.organization_website = attributes['website']
  enterprise.contact_email = attributes['email'].try(:strip)
  enterprise.contact_person = attributes['contact_person_name']
  enterprise.city = attributes['city']
  enterprise.zip_code = attributes['zip_code']
  


  enterprise.created_at = Time.zone.parse(attributes['created_at_gmt'])
#  p "attributes"
#  pp attributes
#  p "categories"


  if enterprise.valid?
    enterprise.save

    if enterprise.errors.count == 0

      if attributes['hits'] != nil and !attributes['hits'].empty?
        enterprise.home_page.hits = attributes['hits'].to_i
	enterprise.home_page.save
      end

      #import avatar
      avatar = attributes['avatar']
      if !avatar.empty?
        m_avatar = /\/\/(?<site>[^\/]+)(?<path>\/.*$)/.match(avatar)

        #download avatar
        Net::HTTP.start(m_avatar[:site]) do |http|
          resp = http.get(m_avatar[:path])

          m_filename = /\/(?<filename>[^\/]*)$/.match(m_avatar[:path])
          filename = 'download/'+m_filename[:filename]
          open(filename, "wb") { |file| file.write(resp.body) }
          mimetype = `file -ib #{filename}`.gsub(/\n/,"")

          u = UploadedData.new
          u.size = resp.body.size
          u.path = filename
          u.content_type = mimetype

          im = Image.new
          #im.uploaded_data = ActionController::TestUploadedFile.new(filename, mimetype)
          im.uploaded_data = u
          im.save
          enterprise.image = im
          enterprise.save

        end
      end

      enterprise.categories = attributes['categories'].map{ |id| 
        if $categories[id.to_i] != nil
          return $categories[id.to_i]['record']
        else 
          puts "Error category not found: #{id} (enterprise: #{attributes['title']})"
        end 
      }

      return enterprise

    else
      p "Could not insert enterprise: " + attributes['title'] + ". Errors: " + enterprise.errors.to_json
    end
  else
    p "Could not insert enterprise: " + attributes['title'] + ". Errors: " + enterprise.errors.to_json
    return nil
  end
end

Categories = JSON.parse File.read ARGV[0]
Enterprises = JSON.parse File.read ARGV[1]

Categories.each{ |category| $categories[category['id'].to_i] = category }

$environment = Environment.default

Time.zone = 'UTC'

$categories.each do |id, attributes|
  create_category attributes
end
Enterprises.each do |attributes|
  if attributes['avatar'].present?
    create_enterprise attributes
    break
  end
end

